# 应用开发笔记

## 一、应用开发方法

根据官方文档的说明，应在`rt-smart/kernal/bsp/boardname/applications`目录下开发用户应用程序

链接地址：https://www.rt-thread.org/document/site/#/rt-thread-version/rt-thread-standard/application-note/setup/standard-project/an0017-standard-project

> BSP 下的 applications 文件夹用于存放用户自己的应用代码，目前只有一个 `main.c `文件。如果用户的应用代码不是很多，建议相关源文件都放在这个文件夹下面，本文在 applications 文件夹下新增了 2 个简单的文件 `hello.c 和 hello.h`。

``` c
/* file: hello.h */

#ifndef _HELLO_H_
#define _HELLO_H_

int hello_world(void);

#endif /* _HELLO_H_ */

/* file: hello.c */
#include <stdio.h>
#include <finsh.h>
#include <rtthread.h>

int hello_world(void)
{
    rt_kprintf("Hello, world!\n");

    return 0;
}

MSH_CMD_EXPORT(hello_world, Hello world!)
```

> 那么用户如何加入自己的应用程序的初始化代码呢？RT-Thread 将 main 函数作为了用户代码入口，只需要在 main 函数里添加自己的代码即可。

``` c
#include <rtthread.h>
#include <board.h>
#include "hello.h"

int main(void)
{
    /* user app entry */

    hello_world();

    return 0;
}
```

> RT-Thread 还支持 finsh，提供一套供用户在命令行的操作接口，通过使用宏 `MSH_CMD_EXPORT()` 就可以新增一个自己命令，并可以在命令行端启动自己的应用代码。

更多内容，包括`SConscript`文件的编写方法，可参考链接页面。

## 二、`helloworld`开发

2.1 在`bsp/board/applications`文件夹下开发

按照文档进行，已实现

2.2以模块方式开发

1. 在`bsp/board`路径下新建文件夹`ledoen`,在该文件夹下新建源文件`ledoen.c, ledoen.h`

2. 在该文件夹下添加`SConscript`文件，内容为

   ```python
   # -*- coding: UTF-8 -*-             # 指定文件的编码格式是 UTF-8，文件可以用中文
   Import('RTT_ROOT')
   Import('rtconfig')
   from building import *
   
   cwd          = GetCurrentDir()      # 将当前路径赋值给字符串 cwd
   include_path = [cwd]                # 将当前头文件路径保存到 list 变量 include_path 中
   src          = []                   # 定义一个 list 变量 src
   
   if GetDepend(['RT_USING_LEDOEN']):   # hello.c 依赖宏 RT_USING_HELLO
       src += ['hello_ledoen.c']              # 保存 hello.c 字符串到 list 变量 src 中
   
   # 将 src 包含的源文件创建为 hello 组。depend 为空表示该组不依赖 rtconfig.h 的任何宏。
   # CPPPATH = include_path 表示将当前目录添加到系统的头文件路径中
   group = DefineGroup('ledoen', src, depend = [''], CPPPATH = include_path)
   
   Return('group')
   ```

3. 编译，下载到开发板（`uboot`方式）运行，成功。可以使用`hello_ledoen`命令成功执行代码

4. 添加开机初始化

   - 在`applications/main.c`文件中添加如下代码

     ``` c
     #include "ledoen.h"
     int main(void)
     {
         ...
         hello_ledoen();
         ...
     }
     ```

   - 编译执行，成功

## 三、LED控制功能开发

在第二步的基础上进行开发

修改`ledoen.c`

```c
#include <stdio.h>
#include <finsh.h>
#include <rtthread.h>
/*LED 相关的头文件*/
#include <rtdevice.h>
#include "drv_pin.h"

#define LED_PIN    GET_PIN(1,9)

int hello_ledoen(void)
{
	rt_pin_mode(LED_PIN, PIN_MODE_OUTPUT);
	int i = 0;
	for(i=0; i<59; i++)
	{
		rt_pin_write(LED_PIN, PIN_HIGH);
		rt_thread_mdelay(500);
		rt_pin_write(LED_PIN, PIN_LOW);
		rt_thread_mdelay(500);
	}
	rt_kprintf("hello ledoen!\n");

	return 0;
}
MSH_CMD_EXPORT(hello_ledoen, "hello ledoen!")
```

## 四、加入进程功能

第三步的实现方法会使主界面出现阻塞现象，使用进程/线程功能避免这一现象